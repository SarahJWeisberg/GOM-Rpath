---
title: "GOM-Rpath"
author: "Sarah Weisberg"
date: "10/1/2020"
bibliography: biblio.json
output:
  html_document: default
  pdf_document: default
  word_document: default
---


```{r setup, echo=FALSE}
library(knitr)
knitr::opts_chunk$set(
  comment = '#>',
  collapse = T)

#Load required packages
library(Rpath); library(data.table); library(survdat); library(ggplot2); library(rgdal); library(here);library(readr)

#install.packages("remotes")
#remotes::install_github("NOAA-EDAB/survdat",build_vignettes = TRUE)


```

## Introduction
This repository contains all of the background code for a mass-balanced food web model of the Gulf of Maine (GOM), which is built using the open-sourced mass balance algorithms of Rpath [@lucey2020]. The GOM model has been parameterized for the 1980-1985 time period, and fit to time series between 1985-2020. 56 functional groups are represented in the model, including *31* single fish species of commercial and/or ecological importance in the GOM. 

Biomass estimates are derived primarily from NOAA's bottom trawl survey. For species and groups not well-covered by the survey -- such as lower trophic levels and marine mammals -- estimates are from the Energy Modeling and Analysis eXercise (EMAX) completed by the Northeast Fisheries Science Center (NEFSC) [@link2006]. The latter was a large-scale effort among dozens of researches to collate known biological parameter estimates for key species and groups across the Northeast US Continental Shelf Ecosystem and produced mass-balanced models of the GOM, Georges Bank (GB), Southern New England and the Mid-Atlantic Bight (MAB) -- efforts that have been foundational towards holistic understanding of the region. However, the EMAX models are highly aggregated, with 31 functional groups; more recent models have attempted to increase resolution and thereby allow for more nuanced questions to be asked and answered. The present model aims to do the same. Additionally, it is created alongside updated Rpath models of both GB and the MAB, in order to facilitate comparative analyses. In keeping with the GB fall model, biomass estimates are based on fall survey data. 
As in the GB model, initial biological parameter estimates are derived from either the EMAX estimates or the more recent model by Buchheister et al. [-@buchheister]. Where appropriate, estimates were also pulled from Heymans (2001) or Dias et al. [@dias2019].

- key data sources = bottom trawl survey, NOAA landings data (aggregated  stomach content analysis data for diet matrix, EMAX and NWACS models for species not collected in trawl.
- I define GOM as bottom trawl strata 1220, 1240, 1260:1290, 1360:1400, 3560:3830 and statistical areas 500, 510, 512:515, 521 & 522 for landings analysis.
- Code is frequently adapted from Sean Lucey's tools for survey analysis (cite) & Rpath model creating
- Group structure within model designed to be able to be analogous to Georges Bank Rpath model

## Generating list of functional groups
-add more detail on how these groups were derived
-Cut-off of biomass from trawl data to be considered as single species
-Included if the biomass exceeded that threshold at any time during the time series
-Groups in EMAX but not in trawl are included as well
-Macrobenthos estimates are from EMAX?
-Try to keep alignment with Georges Bank model


```{r groups, echo=TRUE}
#Functional groups for GOM RPath model
GOM.groups <-as.data.table(c('Phytoplankton', 'Bacteria', 'Microzooplankton', 'GelZooplankton','LgCopepods', 'SmCopepods', 'Micronekton', 'Illex','Loligo', 'OtherCephalopods','Macrobenthos','AmLobster','OceanPout','SmPelagics','SmFlatfishes','NShrimp','OtherShrimps','RiverHerring','AtlScallop','OtherPelagics','AtlHerring','Mesopelagics','YTFlounder','Cod','Haddock','AmPlaice','AtlMackerel','AtlHalibut','SummerFlounder', 'Cusk','OtherDemersals','HMS','OtherSkates','RedHake','Barndoor','Fourspot','SmoothDogfish','Pollock','Goosefish','SilverHake','WhiteHake','SpinyDogfish','Redfish','LittleSkate','SeaBirds','Windowpane','WinterFlounder','WitchFlounder','BlackSeaBass','Butterfish','Sharks','WinterSkate','Pinnipeds','BaleenWhales','Odontocetes', 'Megabenthos'))
setnames(GOM.groups,'V1','RPATH')

```


## Compiling Biomass Data

### Generating Biomass Estimates of Surveyed Species
Load in NEFSC bottom trawl data ('survdat') from all time, shape file of survey strata ('strata') and species list for matching survey species codes with RPATH codes ('spp'). Species of low abundance / biomass are aggregated into larger functional groups. Estimate annual mean stratified biomass for each RPATH group surveyed in the trawl survey, using fall data only. Multiply by total area surveyed per year and divide by area swept per tow to generate swept area biomass. Divide by total survey area to arrive at biomass density estimate (t/km^2). Average over 1980-1985.

```{r survey biomass}
#Load data------------------------------------------------------------------

#Load survey data
load('data/NEFSC_BTS_2021_all_seasons.RData')

#Calculate mean stratified biomass
#GOM strata
#Fall season only
stratmean<-calc_stratified_mean(surveyData=survey$survdat, areaPolygon = 'NEFSC strata', areaDescription = 'STRATA', filterByArea = c(1220, 1240, 1260:1290, 1360:1400, 3560:3830), filterBySeason= "FALL", groupDescription = "SVSPP", filterByGroup = "all", mergesexFlag = T, tidy = F, returnPrepData = F)

#Merge stratified means with RPATH names
stratmean<-merge(stratmean,spp[,list(SVSPP,RPATH,SCINAME,Fall.q)], by = 'SVSPP')

#Calculate swept area biomass
swept<-calc_swept_area(surveyData=survey$survdat, areaPolygon = 'NEFSC strata', areaDescription = 'STRATA', filterByArea = c(1220, 1240, 1260:1290, 1360:1400, 3560:3830), filterBySeason= "FALL", groupDescription = "SVSPP", filterByGroup = "all", mergesexFlag = T,tidy = F, q = NULL, a = 0.0384)

#Merge swept area biomass with RPATH names
swept<-merge(swept,spp[,list(SVSPP,RPATH,SCINAME,Fall.q)], by = 'SVSPP')

#Merge with RPATH names
#RPATH names are the same as in Georges Bank model
#Aggregate groups below 0.05 t/km^2 threshold
spp <- spp[!duplicated(spp$SVSPP),] #SVSPPs are NEFSC species-specific codes
spp <- spp[RPATH == 'RedCrab', RPATH := 'Macrobenthos']
#spp <- spp[RPATH == 'AtlScallop', RPATH := 'Megabenthos'] #Need to come back to this!
spp <- spp[RPATH == 'Clams', RPATH := 'Megabenthos']
spp <- spp[RPATH == 'Scup', RPATH := 'OtherDemersals']
spp <- spp[RPATH == 'OffHake', RPATH := 'OtherDemersals']
spp <- spp[RPATH == 'Bluefish', RPATH := 'OtherPelagics']
spp <- spp[RPATH == 'AmShad', RPATH := 'SmPelagics']
spp <- spp[RPATH == 'SmallPelagics', RPATH := 'SmPelagics']
spp <- spp[RPATH == 'AtlCroaker', RPATH := 'SouthernDemersals']
spp <- spp[RPATH == 'LargePelagics', RPATH := 'OtherPelagics']
spp <- spp[RPATH == 'OtherFlatfish', RPATH := 'OtherDemersals']
spp <- spp[RPATH == 'StripedBass', RPATH := 'OtherPelagics']
spp <- spp[RPATH == 'Sturgeon', RPATH := 'OtherDemersals']
spp <- spp[RPATH == 'Weakfish', RPATH := 'OtherDemersals']

#Cusk not included in Georges Bank model -- need to create RPATH name
spp <- spp[SCINAME == 'BROSME BROSME', RPATH := 'Cusk']

#Calcuate biomass / area in mt
swept <- swept[, biomass.area   := (tot.biomass*.001)/(Fall.q*area)]

#average over 1980-85
setkey(swept,RPATH,YEAR)
swept <- swept[, sum(biomass.area), by = key(swept)]
setnames(swept, 'V1','Biomass')
biomass.80s<-swept[YEAR %in% 1980:1985, mean(Biomass), by=RPATH]
setnames(biomass.80s, 'V1','Biomass')

kable(biomass.80s, booktabs = F, align = 'c')

#Output results to csv
write.csv(biomass.80s, 'Survey_Biomass_GoM_1980-85_v2.csv')

```

##Pulling biomass estimates from EMAX model
-consider adding code to pull data from Ecobase
-using EMAX biomass esimates for non-trawled species, or for aggregate groups where appropriate

```{r EMAX biomass}
#Load data------------------------------------------------------------------

#load EMAX model
GOM.EMAX<-as.data.table(read.csv('GOM_EMAX_params.csv'))

##Merge group list with survey biomass estimates
GOM.groups<-merge(biomass.80s, GOM.groups, by = 'RPATH', all.y=TRUE)
setnames(GOM.groups,'V1','Biomass', skip_absent = TRUE)

#Filter EMAX model for group and biomass only
setnames(GOM.EMAX,'model.Group','RPATH')
setnames(GOM.EMAX,'model.Biomass','Biomass')
GOM.EMAX<-GOM.EMAX[, c('RPATH','Biomass')]

#Change EMAX names to match RPATH names
GOM.EMAX<-GOM.EMAX[RPATH == 'Small copepods', RPATH := 'SmCopepods',]
GOM.EMAX<-GOM.EMAX[RPATH == 'Large Copepods', RPATH := 'LgCopepods',]
GOM.EMAX<-GOM.EMAX[RPATH == 'Sea Birds', RPATH := 'SeaBirds',]
GOM.EMAX<-GOM.EMAX[RPATH %like% 'Macro', RPATH:='Macrobenthos',]
GOM.EMAX<-GOM.EMAX[RPATH %like% 'Baleen', RPATH := 'BaleenWhales',]
GOM.EMAX<-GOM.EMAX[RPATH %like% 'Gel',RPATH := 'GelZooplankton',]
GOM.EMAX<-GOM.EMAX[RPATH %like% 'Phyto', RPATH :='Phytoplankton',]
GOM.EMAX<-GOM.EMAX[RPATH %like% 'Megabenthos',RPATH := 'Megabenthos',]
GOM.EMAX<-GOM.EMAX[RPATH %like% 'Pelagics',RPATH := 'Pelagics',]
GOM.EMAX<-GOM.EMAX[RPATH %like% 'Demersals',RPATH := 'Demersals',]
GOM.EMAX<-GOM.EMAX[RPATH %like% 'Sharks', RPATH :='Sharks']

#Aggregate EMAX macrobenthos groups into one 
MacrobenthosBiomass<-GOM.EMAX[RPATH == 'Macrobenthos', sum(Biomass),]
GOM.EMAX<-GOM.EMAX[RPATH == 'Macrobenthos', Biomass:=MacrobenthosBiomass,]

#Aggregate EMAX megabenthos groups into one, subtracting lobster and scallops
MegabenthosBiomass<-GOM.EMAX[RPATH == 'Megabenthos', sum(Biomass)] - GOM.groups[RPATH == 'AmLobster', Biomass] - GOM.groups[RPATH == 'AtlScallop', Biomass]
GOM.EMAX<-GOM.EMAX[RPATH == 'Megabenthos', Biomass:=MegabenthosBiomass,]

#Remove groups not included in Rpath model
GOM.EMAX<- GOM.EMAX[!RPATH %in% c('Larval-juv fish- all','Shrimp et al.','Pelagics','Demersals','Discard','Detritus-POC','Fishery'),]
GOM.EMAX<-unique(GOM.EMAX)

#Merge survey and EMAX biomass estimates
biomass.80s<-merge(GOM.groups,GOM.EMAX,by='RPATH', all=TRUE)
biomass.80s<-biomass.80s[is.na(Biomass.y) , Biomass.y := Biomass.x]
biomass.80s<-biomass.80s[,Biomass.x :=NULL]
setnames(biomass.80s,"Biomass.y","Biomass")

#save as .csv, generate table
write.csv(biomass.80s, 'GOM_Biomass_1980-1985.csv')

kable(biomass.80s, booktabs = T, align = 'c')

```

#Generating fleet strucutre
-From commercial landings data
-Use statistical areas 500, 510, 512:515, 521, 522
-Segmented by major gear type
-Esimated mean landings for 1980-85, divide by total area

```{r fleets, echo=TRUE}

#Load data------------------------------------------------------------------
#load commercial landings data 
load("~/Desktop/RPath-GOM-workshop/comland_meatwt_deflated_stat_areas.RData")

#Load shape files and calculate total area
stat.areas <- readOGR('gis','Statistical_Areas_2010')

#Calculate total commercial fishing area included in GOM model
stat.areas.area <- getarea(stat.areas, 'Id')
GOM.com.area <- stat.areas.area[Id %in% c(500, 510, 512:515, 521, 522), sum(Area)]

#delete NAs
spp <- unique(spp[!is.na(NESPP3), list(NESPP3, RPATH)])
comland <- comland[!is.na(NESPP3)]

#check for duplicate NESPP3 entries, reassign, remove duplicates
spp.dupes<-spp[duplicated(NESPP3)]
spp<-spp[NESPP3 %in% spp.dupes$NESPP3, RPATH := 'OtherDemersals']
spp <- unique(spp)

#merge landings with species codes
landings <- as.data.table(merge(comland, spp, by = 'NESPP3'))

#subset for GOM 
GOM.stat.areas <- c(500, 510, 512:515, 521, 522)
GOM.landings <- landings[AREA %in% GOM.stat.areas, ]

#Decouple small and large otter trawl fisheries
GOM.landings[SIZE == 'small' & GEAR == 'otter', GEAR := 'otter.sm']
GOM.landings[SIZE == 'large' & GEAR == 'otter', GEAR := 'otter.lg']

#Sum by RPATH group
GOM.sums <- GOM.landings[, sum(SPPLIVMT), by = c('YEAR', 'RPATH', 'GEAR')]
setnames(GOM.sums, 'V1', 'SPPLIVMT')

#Subset & sum for 1980-1985
GOM.landings <- GOM.landings[YEAR %in% 1980:1985]
GOM.sums <- GOM.landings[, sum(SPPLIVMT), by = c('YEAR', 'RPATH', 'GEAR')]
setnames(GOM.sums, 'V1', 'SPPLIVMT')

#Get five year means
GOM.landings <- GOM.sums[YEAR %in% 1980:1985, mean(SPPLIVMT), by = c('RPATH', 'GEAR')]
setnames(GOM.landings, 'V1', 'SPPLIVMT')

#Calculate landings in mt / km^2
GOM.landings <- GOM.landings[, SPPLIVMT := SPPLIVMT / GOM.com.area]

```

#Estimating biological parameters
-Explain data sources - NWACS, EMAX, GB model
-Code below is for filling in bioparams table from NWACS -- results should give the same as in Sean's inital (pre-balanced) model, not sure if the code is helpful to include here?
-Developed bioparams table by hardcoding parameter values from NWACS, GB model, EMAX, and/or Heymans (2001)
-Use Sean's model
-Add code for pulling data

```{r NWACS}
#NWACS <- data.table(Group = c('Phytoplankton', 'Other primary producers', 'Bacteria','Microzooplankton', 'Small Copepods', 'Large Copepods','Gelatinous zooplankton', 'Micronekton', 'Macrobenthos- polychaetes', 'Macrobenthos- crustaceans', 'Macrobenthos- molluscs', 'Macrobenthos- other','Megabenthos- filterers', 'Megabenthos- other', 'Shrimp and Similar Species', 'Mesopelagics','Atlantic herring', 'Alosines', 'Atlantic menhaden (S)', 'Atlantic menhaden (M)', 'Atlantic menhaden (L)', 'Anchovies', 'Atlantic mackerel', 'Squid', 'Butterfish','Small pelagics- other', 'Bluefish (S)', 'Bluefish (M)', 'Bluefish (L)', 'Striped bass (S)', 'Striped bass (M)','Striped bass (L)', 'Weakfish (S)', 'Weakfish (M)', 'Weakfish (L)', 'Spiny dogfish (S)', 'Spiny dogfish (L)','Atlantic cod (S)', 'Atlantic cod (M)', 'Atlantic Cod (L)','Haddock', 'Hake', 'Atlantic croaker','Yellowtail flounder (S)', 'Yellowtail flounder (L)', 'Summer flounder (S)', 'Summer flounder (L)', 'Skates','Demersal benthivores - other', 'Demersal piscivores - other','Demersal omnivores - other', 'Medium pelagics - other','Sharks - coastal', 'Sharks - pelagic', 'Large pelagics (HMS)', 'Pinnipeds', 'Baleen whales', 'Odontocetes', 'Seabirds', 'Nearshore pisc birds', 'Detritus'),Biomass = c(30.000, 1.605, 7.700, 7.000, 16.000, 17.966, 6.349, 7.654, 17.452, 7.000, 8.340, 21.000, 5.500, 4.498,  0.470, 0.090, 1.650, 0.200, 0.371, 2.048, 1.200,1.100, 1.740, 1.267, 1.488, 1.400, 0.017, 0.160, 0.509, 0.003, 0.022, 0.022, 0.006, 0.038, 0.036,0.337, 0.800, 0.055, 0.144, 0.277, 0.254, 1.100,0.350, 0.007, 0.187, 0.010, 0.159, 1.000, 2.300,1.300, 1.100, 0.021, 0.008, 0.016, 0.070, 0.035,0.464, 0.060, 0.007, 0.007, 52.6),PB = c(180.700, 55.570, 91.250, 85.000, 46.000, 46.000, 40.000,14.250, 2.500, 3.600, 2.200, 2.000, 1.200, 2.300, 2.000,1.100, 1.100, 1.300, 1.900, 1.309, 0.756, 2.200, 0.550,5.720, 1.312, 1.200, 3.900, 0.900, 0.310, 1.500, 0.526, 0.317, 3.300, 0.900, 1.000, 0.321, 0.321, 1.087, 1.125, 0.700, 0.700, 1.296, 0.994, 2.700, 0.850, 2.200, 1.050,0.250, 0.550, 0.450, 0.550, 0.450, 0.200, 0.113, 0.579, 0.075, 0.040, 0.040, 0.279, 0.279, NA), QB = c(0.000, 0.000, 380.208, 283.400, 140.000, 150.000, 145.326,85.497, 17.500, 21.000, 13.949, 16.059, 6.660, 15.533,6.660, 3.700, 3.700, 4.400, 15.860, 6.643, 3.785, 7.333, 2.170, 19.000, 4.230, 4.000, 20.935, 6.093, 3.139, 10.265, 3.429, 1.820, 13.520, 4.689, 2.803, 3.519, 1.810, 5.059, 2.603, 1.500, 3.000, 3.850, 3.550, 12.168, 2.900, 10.283, 2.900, 0.900, 1.833, 1.500, 1.833, 1.838, 1.247,0.690, 6.794, 5.581, 3.217, 14.301, 80.000, 80.000, NA), RPATH = c('Phytoplankton', 'Phytoplankton', 'Bacteria', 'Microzooplankton', 'Mesozooplankton', 'Mesozooplankton','GelZooplankton', 'Micronekton',rep('Macrobenthos', 4), 'Megabenthos', 'AmLobster','OtherShrimps', 'Mesopelagics', 'AtlHerring', 'SmPelagics',rep('OtherPelagics', 3), 'SmPelagics', 'AtlMackerel','Illex', 'Butterfish', 'SmPelagics', rep('Bluefish', 3),rep('OtherPelagics', 3), rep('SouthernDemersals', 3), rep('SpinyDogfish', 2), rep('Cod', 3), 'Haddock','RedHake', 'SouthernDemersals', rep('YTFlounder', 2),rep('SummerFlounder', 2), 'WinterSkate', rep('OtherDemersals', 3), 'OtherPelagics', rep('Sharks', 2),'HMS', 'Seals', 'BalWhale', 'ToothWhale', 'Seabirds','Seabirds', 'Detritus'))

#Calculate weighted mean
#NWACS[, Rpath.bio := sum(Biomass), by = RPATH]
#NWACS[, PB.weight := Biomass * PB]
#NWACS[, new.PB := sum(PB.weight) / Rpath.bio, by = RPATH]
#NWACS[, QB.weight := Biomass * QB]
#NWACS[, new.QB := sum(QB.weight) / Rpath.bio, by = RPATH]
```

#Biomass Accumulation
-purpose of this code is to determine which groups need a non-zero biomass accumulation term in the model
-strategy is to fit a simple linear model to biomass trend over time and then select for models with $p \leq 0.05$ and $ |slope| \geq 0.005$.
```{r}
#RPATH GOM groups
survey.groups <- as.data.table(unique(swept$RPATH))
colnames(survey.groups)<-"RPATH"
survey.groups<-na.omit(survey.groups)

#Fit linear model to biomass trends all surveyed RPATH groups, extract slope
ba<-c()
p<-c()
for (i in 1:46){
    lm<-lm(Biomass~YEAR, data = subset(swept, RPATH == survey.groups$RPATH[i]))
    spF <- as.numeric(summary(lm)$fstatistic)
    p[i] <- pf(spF[1], spF[2], spF[3], lower = F)
    ba[i] <-as.numeric(lm[[1]][2])
}

biomass.accum<-cbind(survey.groups,ba,p)
biomass.accum<-subset(biomass.accum, p<=0.05 & abs(ba) >= 0.005)

write.csv(biomass.accum,'ba.csv')
```

#Placeholder for params table
```{r}

```
#Diet matrix
```{r}
## Import data
prey <- as.data.table(read_csv("SASPREY12B.csv"))

#Match prey codes with RPath group names
#Start with 1:1
prey[PYCOMNAM == 'ATLANTIC HERRING',        RPATH := 'AtlHerring']
prey[PYCOMNAM == 'ATLANTIC MACKEREL',       RPATH := 'AtlMackerel']
prey[PYCOMNAM == 'BUTTERFISH',              RPATH := 'Butterfish']
prey[PYCOMNAM == 'BUTTERFISH OTOLITHS',     RPATH := 'Butterfish']
prey[PYCOMNAM == 'ATLANTIC COD',            RPATH := 'Cod']
prey[PYCOMNAM == 'HADDOCK',                 RPATH := 'Haddock']
prey[PYCOMNAM == 'GOOSEFISH',               RPATH := 'Goosefish']
prey[PYCOMNAM == 'OFFSHORE HAKE',           RPATH := 'OtherDemersals']
prey[PYCOMNAM == 'SILVER HAKE',             RPATH := 'SilverHake']
prey[PYCOMNAM == 'SILVER HAKE OTOLITHS',    RPATH := 'SilverHake']
prey[PYCOMNAM == 'RED HAKE',                RPATH := 'RedHake']
prey[PYCOMNAM == 'WHITE HAKE',              RPATH := 'WhiteHake']
prey[PYCOMNAM == 'ACADIAN REDFISH',         RPATH := 'Redfish']
prey[PYCOMNAM == 'POLLOCK',                 RPATH := 'Pollock']
prey[PYCOMNAM == 'OCEAN POUT',              RPATH := 'OceanPout']
prey[PYCOMNAM == 'BLACK SEA BASS',          RPATH := 'BlackSeaBass']
prey[PYCOMNAM == 'BLUEFISH',                RPATH := 'OtherPelagics']
prey[PYCOMNAM == 'SCUP',                    RPATH := 'OtherDemersals']
prey[PYCOMNAM == 'FOURSPOT FLOUNDER',       RPATH := 'Fourspot']
prey[PYCOMNAM == 'SUMMER FLOUNDER',         RPATH := 'SummerFlounder']
prey[PYCOMNAM == 'AMERICAN PLAICE',         RPATH := 'AmPlaice']
prey[PYCOMNAM == 'WINDOWPANE',              RPATH := 'Windowpane']
prey[PYCOMNAM == 'WINTER FLOUNDER',         RPATH := 'WinterFlounder']
prey[PYCOMNAM == 'WITCH FLOUNDER',          RPATH := 'WitchFlounder']
prey[PYCOMNAM == 'YELLOWTAIL FLOUNDER',     RPATH := 'YTFlounder']
prey[PYCOMNAM == 'SPINY DOGFISH',           RPATH := 'SpinyDogfish']
prey[PYCOMNAM == 'SMOOTH DOGFISH',          RPATH := 'SmoothDogfish']
prey[PYCOMNAM == 'LITTLE SKATE',            RPATH := 'LittleSkate']
prey[PYCOMNAM == 'NORTHERN SHORTFIN SQUID', RPATH := 'Illex']
prey[PYNAM    == 'ILLEX SP',                RPATH := 'Illex']
prey[PYCOMNAM == 'AMERICAN LOBSTER',        RPATH := 'AmLobster']
prey[PYCOMNAM == 'KRILL',                   RPATH := 'Micronekton'] 
prey[PYCOMNAM == 'EMPTY STOMACH',           RPATH := 'Empty']
prey[PYCOMNAM == 'BLOWN STOMACH',           RPATH := 'Blown']
prey[PYCOMNAM == 'NORTHERN SHRIMP',         RPATH := 'NShrimp']
prey[PYCOMNAM == 'HORSESHOE CRAB',          RPATH := 'Megabenthos']
prey[PYCOMNAM == 'ALEWIFE',          RPATH := 'RiverHerring']
prey[PYNAM == 'SELENE SETAPINNIS', RPATH := 'SmPelagics']
prey[PYNAM == 'EPIGONUS PANDIONIS', RPATH := 'OtherDemersals']
#Need to revisit River Herring classification

#Easy many to ones
prey[PYCOMNAM %in% c('SEA SCALLOP', 'SEA SCALLOP VISCERA'), RPATH := 'Megabenthos']
prey[PYCOMNAM %in% c('ATLANTIC SURFCLAM', 'SURFCLAM VISCERA', 'OCEAN QUAHOG', 
                     'OCEAN QUAHOG VISCERA', 'OCEAN QUAHOG SHELL'), RPATH := 'Megabenthos']
prey[PYCOMNAM %in% c('LONGFIN SQUID', 'LOLIGO SP PEN'), RPATH := 'Loligo']
prey[PYNAM    %in% c('LOLIGO SP', 'LOLIGO SP BEAKS'),   RPATH := 'Loligo']

#Use higher level categories
#A majority of unassigned prey are in the MODCAT BENINV - whittle out those that 
#don't go into macrobenthos then assign the rest

#Megabenthos - Asteroids, mantis shrimp, crabs other than hermits, lobsters
prey[is.na(RPATH) & AnalCom == 'STARFISH', RPATH := 'Megabenthos']
prey[is.na(RPATH) & AnalCom == 'MANTIS SHRIMPS', RPATH := 'Megabenthos']
prey[is.na(RPATH) & Collcom %in% c('CANCER CRABS', 'DECAPODA CRAB', 'DECAPODA', 
                                   'DECAPODA LARVAE', 'LOBSTER', 'BLUE CRAB', 
                                   'SLIPPER LOBSTERS'), RPATH := 'Megabenthos']

#GelZooplankton/Cephalopods/Shrimp
prey[is.na(RPATH) & AnalCom == 'SQUIDS, OCTOPUS', RPATH := 'OtherCephalopods']
prey[is.na(RPATH) & Collcom %in% c('JELLYFISH', 'CNIDARIA', 'HYDROZOA'), RPATH := 'GelZooplankton']       
prey[is.na(RPATH) & Collcom %in% c('PANDALIDAE', 'PENAEIDAE', 'DECAPODA SHRIMP', 'CRAGONID SHRIMP'), RPATH := 'OtherShrimps']

#Macrobenthos
prey[is.na(RPATH) & MODCAT == 'BENINV', RPATH := 'Macrobenthos']

#MODCAT PELINV
prey[is.na(RPATH) & Collcom == 'COMB JELLIES', RPATH := 'GelZooplankton']
prey[PYCOMNAM == 'ROTIFERS', RPATH := 'Microzooplankton']
prey[is.na(RPATH) & Collcom == 'KRILL', RPATH := 'Micronekton'] 
prey[is.na(RPATH) & Collcom == 'COPEPODA', RPATH := 'LgCopepods']
prey[is.na(RPATH) & MODCAT == 'PELINV', RPATH := 'Micronekton']

#MODCAT LDEM
prey[is.na(RPATH) & ANALCAT %in% c('BOTFAM', 'SOLFAM'), RPATH := 'SmFlatfishes']
prey[is.na(RPATH) & ANALCAT == 'RAJORD', RPATH := 'OtherSkates']
prey[is.na(RPATH) & ANALCAT %in% c('LUTFAM', 'SCAFAM', 'SCIFAM', 'SPAFAM', 'SERFA3'), RPATH := 'OtherDemersals']
prey[is.na(RPATH) & ANALCAT == 'SHARK', RPATH := 'Sharks']
prey[is.na(RPATH) & ANALCAT == 'MACFAM', RPATH := 'Mesopelagics']
prey[is.na(RPATH) & ANALCAT %in% c('PLEFAM', 'PLEORD'), RPATH := 'OtherDemersals']
prey[is.na(RPATH) & MODCAT == 'LDEM', RPATH := 'OtherDemersals']
#Need to revisit ANALCAT GADFAM - Gadidae, urophycis sp

#MODCAT LPEL
prey[PYCOMNAM %in% c('BOA DRAGONFISH', 'VIPERFISH'), RPATH := 'Mesopelagics']
prey[is.na(RPATH) & MODCAT == 'LPEL' & ANALCAT %in% c('CARFAM', 'POMFAM', 'SALSAL','SCOFAM', 'OTHFIS'), RPATH := 'OtherPelagics']
prey[is.na(RPATH) & MODCAT == 'LPEL', RPATH := 'SmPelagics']

#MODCAT SDEM
prey[PYCOMNAM == 'DRAGONET FISH', RPATH := 'Mesopelagics']
prey[is.na(RPATH) & AnalCom == 'GREENEYES', RPATH := 'Mesopelagics']
prey[is.na(RPATH) & MODCAT == 'SDEM', RPATH := 'OtherDemersals']

#MODCAT SPEL
prey[is.na(RPATH) & MODCAT == 'SPEL' & AnalCom == 'LANTERNFISHES', RPATH := 'Mesopelagics']
prey[PYABBR == 'MAUWEI', RPATH := 'Mesopelagics']
prey[is.na(RPATH) & MODCAT == 'SPEL' & AnalCom == 'HERRINGS', RPATH := 'RiverHerring']
prey[is.na(RPATH) & MODCAT == 'SPEL', RPATH := 'SmPelagics']

#Fish Larvae
prey[is.na(RPATH) & MODCAT == 'FISLAR', RPATH := 'Micronekton']

#Ignoring eggs for now
prey[is.na(RPATH) & MODCAT == 'FISEGG', RPATH := 'NotUsed']

#Miscellaneous - Mostly trash (plastic, twine, rubber)
prey[PYABBR %in% c('POLLAR', 'AMPTUB'), RPATH := 'Macrobenthos']
prey[is.na(RPATH) & MODCAT == 'MISC', RPATH := 'NotUsed']

#Other
prey[PYABBR %in% c('INVERT', 'ARTHRO', 'CRUSTA', 'CRUEGG', 'INSECT', 'UROCHO'),
     RPATH := 'Macrobenthos']
prey[PYABBR %in% c('MARMAM', 'MARMA2', 'DELDEL', 'GLOBSP'), RPATH := 'Odontocetes']
prey[PYABBR %in% c('AVES', 'AVEFEA'), RPATH := 'SeaBirds']
prey[PYABBR %in% c('PLANKT', 'DIATOM'), RPATH := 'Phytoplankton']
prey[is.na(RPATH) & MODCAT == 'OTHER', RPATH := 'NotUsed'] #Plants and Parasites

#Leftovers
prey[AnalCom == 'SAND LANCES', RPATH := 'SmPelagics']
prey[PYABBR %in% c('PERORD', 'MYOOCT'), RPATH := 'OtherDemersals']
prey[PYABBR %in% c('CLUSCA', 'CLUHA2'), RPATH := 'AtlHerring']


#Unidentified Stuff
prey[MODCAT == 'AR', RPATH := 'AR']
prey[is.na(RPATH) & AnalCom == 'OTHER FISH', RPATH := 'UNKFish']
prey[PYABBR == 'FISSCA', RPATH := 'UNKFish']
prey[PYABBR == 'CHONDR', RPATH := 'UNKSkate']
prey[PYABBR == 'PRESER', RPATH := 'NotUsed']

#load stomach data
load("~/Desktop/GOM-Rpath/GOM_foodhabits.RData")

#Assign Rpath codes to predators
GOM.fh <- merge(GOM.fh, spp, by = 'SVSPP', all.x = T)
setnames(GOM.fh, 'RPATH', 'Rpred')

#Assign Rpath codes to prey
GOM.fh <- merge(GOM.fh, prey[, list(PYNAM, RPATH)], by = 'PYNAM', all.x = T)
setnames(GOM.fh, 'RPATH', 'Rprey')

#Remove NotUsed, AR, UNKFish and UNKSkate
GOM.fh <- GOM.fh[!Rprey %in% c('NotUsed', 'AR', 'UNKFish', 'UNKSkate'), ]

#Assign missing RPATH names
GOM.fh<-GOM.fh[PYNAM=='NEPTUNEA DECEMCOSTATA',Rprey:='Macrobenthos']
GOM.fh<-GOM.fh[PYNAM=='STERNOPTYCHIDAE',Rprey:='Mesopelagics']

#Merge prey items
setkey(GOM.fh, YEAR, SEASON, CRUISE6, STRATUM, STATION, TOW, Rpred, PDID, Rprey)
GOM.fh2 <- GOM.fh[, sum(PYAMTW), by = key(GOM.fh)]
setnames(GOM.fh2, 'V1', 'PYAMTW')

#Calculate Percent weight using a cluster sampling design (Nelson 2014)
#Clusters are station/Rpred combos
cluster <- c('CRUISE6', 'STRATUM', 'STATION', 'TOW', 'Rpred')

#Calculate numbers of fish per cluster
GOM.pred <- unique(GOM.fh2, by = c(cluster, 'PDID'))
GOM.pred[, Mi := length(PDID), by = cluster]
GOM.pred <- unique(GOM.pred[, list(CRUISE6, STRATUM, STATION, TOW, Rpred, Mi)])
GOM.pred[, sumMi := sum(Mi), by = Rpred]
GOM.fh2 <- merge(GOM.fh2, GOM.pred, by = cluster)

#Sum prey weight per stomach
GOM.fh2[, yij := sum(PYAMTW), by = c(cluster, 'Rprey')]
GOM.fh2[, mu := yij / Mi]
GOM.cluster <- unique(GOM.fh2, by = c(cluster, 'Rprey'))
GOM.cluster[, c('PYAMTW', 'yij') := NULL]

#Calculate weighted contribution
GOM.cluster[, Miu := Mi * mu]
GOM.cluster[, rhat := Miu / sumMi]
GOM.cluster[, sum.rhat := sum(rhat), by = .(Rpred, Rprey)]

#Grab unique rows
GOM.diet.survey <- unique(GOM.cluster[, list(Rpred, Rprey, sum.rhat)], by = c('Rpred', 'Rprey'))

#Convert to percentages
GOM.diet.survey[, tot.preyw := sum(sum.rhat), by = Rpred]
GOM.diet.survey[, preyper := sum.rhat / tot.preyw]
GOM.diet.survey[, c('sum.rhat', 'tot.preyw') := NULL]
setkey(GOM.diet.survey, Rpred, preyper)

#Remove OtherDemersals, SmPelagics, Illex and Loligo
#Will use EMAX diet estimates for these 4 groups
GOM.diet.survey <- GOM.diet.survey[!Rpred %in% c('OtherDemersals','SmPelagics','Loligo','Illex')]

#Load in params table with biomass as previously calculated
all.groups <- read_csv("GOM_Parameters_V4.csv")
all.groups <- as.data.table(all.groups[,c(1,2,3)])

#Remove EMAX:RPATH many:1s
all.groups <- all.groups[!RPATH %in% c('Megabenthos','Macrobenthos'),]

#Calculate proportionality for EMAX:RPATH many:1s
EMAX.params <- as.data.table(read_csv("GOM_EMAX_params.csv"))

#Megabenthos groups
#Calculate biomass remaining in Megabenthos- filterers after removing scallops
Megabenthos.filterers <- EMAX.params[model.Group == 'Megabenthos- filterers',model.Biomass] - all.groups[RPATH == 'AtlScallop',Biomass]
Megabenthos.filterers <- as.data.table(cbind('Megabenthos',Megabenthos.filterers,'Megabenthos- filterers'))
setnames(Megabenthos.filterers, c("RPATH","Biomass","EMAX"))
#Calculate biomass remaining in Megabenthos- other after removing lobster
Megabenthos.other <-EMAX.params[model.Group == 'Megabenthos- other',model.Biomass] - all.groups[RPATH == 'AmLobster',Biomass]
Megabenthos.other <- as.data.table(cbind('Megabenthos',Megabenthos.other,'Megabenthos- other'))
setnames(Megabenthos.other, c("RPATH","Biomass","EMAX"))

#Macrobenthos groups
Macrobenthos <- as.data.table(EMAX.params[model.Group %like% 'Macrobenthos',c(2,4)])
Macrobenthos <- cbind(Macrobenthos,"Macrobenthos")
setnames(Macrobenthos,c('EMAX','Biomass','RPATH'))

#Micronekton groups
Micronekton <- as.data.table(EMAX.params[model.Group %in% c('Micronekton','Larval-juv fish- all'),c(2,4)])
Micronekton <- cbind(Micronekton,"Micronekton")
setnames(Micronekton,c('EMAX','Biomass','RPATH'))

#SmPelagics groups
SmPelagics <- as.data.table(EMAX.params[model.Group =='Small Pelagics- anadromous', c(2,4)])
SmPelagics <- cbind(SmPelagics,"SmPelagics")
setnames(SmPelagics,c('EMAX','Biomass','RPATH'))

#Merge all groups
all.groups <- rbind(all.groups,Megabenthos.filterers,Megabenthos.other,Macrobenthos,Micronekton,SmPelagics)
all.groups <- all.groups[,Biomass := as.numeric(Biomass)]
all.groups[, EMAX.tot := sum(Biomass), by = EMAX]
all.groups[, Rpath.prop := Biomass / EMAX.tot]


#Whale diet from Laurel - used in Sarah Gaichas's GOM
balwhale <- data.table(EMAX = c('Large Copepods', 'Micronekton', 'Small Pelagics- commercial',
                                'Small Pelagics- other', 'Small Pelagics- squid',
                                'Demersals- benthivores', 'Demersals- omnivores',
                                'Demersals- piscivores'),
                       DC = c(0.15392800, 0.50248550, 0.15509720, 0.08101361, 
                              0.03142953, 0.01532696, 0.01102390, 0.04969525))
balwhale <- merge(balwhale, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
balwhale[, preyper := DC * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
balwhale <- balwhale[, sum(preyper), by = RPATH]
balwhale[, Rpred := 'BaleenWhales']
setnames(balwhale, c('RPATH', 'V1'), c('Rprey', 'preyper'))

#Odontocetes
tooth <- EMAX.params[, list(diet.Odontocetes,diet.Group)]
setnames(tooth,'diet.Group','EMAX')
tooth <- merge(tooth, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
tooth[, preyper := diet.Odontocetes * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
tooth <- tooth[, sum(preyper), by = RPATH]
tooth[, Rpred := 'Odontocetes']
setnames(tooth, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(balwhale,tooth))

#SeaBirds
birds <- EMAX.params[, list(diet.Sea.Birds,diet.Group)]
setnames(birds,'diet.Group','EMAX')
birds <- merge(birds, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
birds[, preyper := diet.Sea.Birds * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
birds <- birds[, sum(preyper), by = RPATH]
birds[, Rpred := 'SeaBirds']
setnames(birds, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,birds))

#Pinnipeds
seals <- EMAX.params[, list(diet.Pinnipeds,diet.Group)]
setnames(seals,'diet.Group','EMAX')
seals <- merge(seals, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
seals[, preyper := diet.Pinnipeds * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
seals <- seals[, sum(preyper), by = RPATH]
seals[, Rpred := 'Pinnipeds']
setnames(seals, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,seals))

#HMS
hms <- EMAX.params[, list(diet.HMS,diet.Group)]
setnames(hms,'diet.Group','EMAX')
hms <- merge(hms, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
hms[, preyper := diet.HMS * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
hms <- hms[, sum(preyper), by = RPATH]
hms[, Rpred := 'HMS']
setnames(hms, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,hms))

#Sharks
sharks <- EMAX.params[, list(diet.Sharks..pelagics,diet.Group)]
setnames(sharks,'diet.Group','EMAX')
sharks <- merge(sharks, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
sharks[, preyper := diet.Sharks..pelagics * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
sharks <- sharks[, sum(preyper), by = RPATH]
sharks[, Rpred := 'Sharks']
setnames(sharks, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,sharks))

#OtherShrimp
shrimp <- EMAX.params[, list(diet.Shrimp.et.al.,diet.Group)]
setnames(shrimp,'diet.Group','EMAX')
shrimp <- merge(shrimp, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
#shrimp <- shrimp[,RPATH.sum := sum(diet.Shrimp.et.al.), by = RPATH]
shrimp[, preyper := diet.Shrimp.et.al. * Rpath.prop]
#shrimp <- unique(shrimp[,c('RPATH','preyper')])
#Need to sum many:1 EMAX:Rpath
shrimp <- shrimp[, sum(preyper), by = RPATH]
others <- copy(shrimp[, Rpred := 'OtherShrimps'])
nshrimp<-copy(shrimp[,Rpred := 'NShrimp'])
setnames(others, c('RPATH', 'V1'), c('Rprey', 'preyper'))
setnames(nshrimp, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,others))
GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,nshrimp))

#GelZooplankton
jelly <- EMAX.params[, list(diet.Gelatinous.Zooplankton,diet.Group)]
setnames(jelly,'diet.Group','EMAX')
jelly <- merge(jelly, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
jelly[, preyper := diet.Gelatinous.Zooplankton * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
jelly <- jelly[, sum(preyper), by = RPATH]
jelly[, Rpred := 'GelZooplankton']
setnames(jelly, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,jelly))

#Microzooplankton
micro <- EMAX.params[, list(diet.Microzooplankton,diet.Group)]
setnames(micro,'diet.Group','EMAX')
micro <- merge(micro, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
micro[, preyper := diet.Microzooplankton * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
micro <- micro[, sum(preyper), by = RPATH]
micro[, Rpred := 'Microzooplankton']
setnames(micro, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,micro))

#Micronekton
micronekton <- EMAX.params[, list(diet.Micronekton,diet.Group)]
setnames(micronekton,'diet.Group','EMAX')
micronekton <- merge(micronekton, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
micronekton[, preyper := diet.Micronekton * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
micronekton <- micronekton[, sum(preyper), by = RPATH]
micronekton[, Rpred := 'Micronekton']
setnames(micronekton, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,micronekton))

#OtherPelagics-- going to try to use diet fromfood habits database for initial balancing, rather than EMAX
#otherpel <- EMAX.params[, list(diet.Medium.Pelagics...piscivores...other.,diet.Group)]
#setnames(otherpel,'diet.Group','EMAX')
#otherpel <- merge(otherpel, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
#otherpel[, preyper := diet.Medium.Pelagics...piscivores...other. * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
#otherpel <- otherpel[, sum(preyper), by = RPATH]
#otherpel[, Rpred := 'OtherPelagics']
#setnames(otherpel, c('RPATH', 'V1'), c('Rprey', 'preyper'))

#GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,otherpel))

#OtherDemersals
otherdem <- EMAX.params[, list(diet.Demersals..benthivores,diet.Group)]
setnames(otherdem,'diet.Group','EMAX')
otherdem <- merge(otherdem, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
otherdem[, preyper := diet.Demersals..benthivores * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
otherdem <- otherdem[, sum(preyper), by = RPATH]
otherdem[, Rpred := 'OtherDemersals']
setnames(otherdem, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,otherdem))

#Lobster - use Megabenthos- other diet
lobster <- EMAX.params[, list(diet.Megabenthos..other,diet.Group)]
setnames(lobster,'diet.Group','EMAX')
lobster <- merge(lobster, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
lobster[, preyper := diet.Megabenthos..other * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
lobster <- lobster[, sum(preyper), by = RPATH]
lobster[, Rpred := 'AmLobster']
setnames(lobster, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,lobster))

#AtlScallop - use Megabenthos- filterers diet
scallop <- EMAX.params[, list(diet.Megabenthos..filterers,diet.Group)]
setnames(scallop,'diet.Group','EMAX')
scallop <- merge(scallop, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
scallop[, preyper := diet.Megabenthos..filterers * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
scallop <- scallop[, sum(preyper), by = RPATH]
scallop[, Rpred := 'AtlScallop']
setnames(scallop, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,scallop))

#OtherCephalopods
ceph <- EMAX.params[, list(diet.Small.Pelagics..squid,diet.Group)]
setnames(ceph,'diet.Group','EMAX')
ceph <- merge(ceph, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
ceph[, preyper := diet.Small.Pelagics..squid * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
ceph <- ceph[, sum(preyper), by = RPATH]
ceph[,Rpred := 'OtherCephalopods']
setnames(ceph, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,ceph))

#Illex - use EMAX squid diet
illex <- EMAX.params[, list(diet.Small.Pelagics..squid,diet.Group)]
setnames(illex,'diet.Group','EMAX')
illex <- merge(illex, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
illex[, preyper := diet.Small.Pelagics..squid * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
illex <- illex[, sum(preyper), by = RPATH]
illex[,Rpred := 'Illex']
setnames(illex, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,illex))

#Loligo - use EMAX squid diet
loligo <- EMAX.params[, list(diet.Small.Pelagics..squid,diet.Group)]
setnames(loligo,'diet.Group','EMAX')
loligo <- merge(loligo, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
loligo[, preyper := diet.Small.Pelagics..squid * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
loligo <- loligo[, sum(preyper), by = RPATH]
loligo[,Rpred := 'Loligo']
setnames(loligo, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,loligo))

#SmCopepods
smcope <- EMAX.params[, list(diet.Small.copepods,diet.Group)]
setnames(smcope,'diet.Group','EMAX')
smcope <- merge(smcope, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
smcope[, preyper := diet.Small.copepods * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
smcope <- smcope[, sum(preyper), by = RPATH]
smcope[,Rpred := 'SmCopepods']
setnames(smcope, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,smcope))

#LgCopepods
lgcope <- EMAX.params[, list(diet.Large.Copepods,diet.Group)]
setnames(lgcope,'diet.Group','EMAX')
lgcope <- merge(lgcope, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
lgcope[, preyper := diet.Large.Copepods * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
lgcope <- lgcope[, sum(preyper), by = RPATH]
lgcope[,Rpred := 'LgCopepods']
setnames(lgcope, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,lgcope))

#SmPelagics - use diet from Small Pelagics- other
smpel <- EMAX.params[, list(diet.Small.Pelagics..other,diet.Group)]
setnames(smpel,'diet.Group','EMAX')
smpel <- merge(smpel, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
smpel[, preyper := diet.Small.Pelagics..other * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
smpel <- smpel[, sum(preyper), by = RPATH]
smpel[,Rpred := 'SmPelagics']
setnames(smpel, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,smpel))

#Bacteria
bacteria <- EMAX.params[, list(diet.Bacteria,diet.Group)]
setnames(bacteria,'diet.Group','EMAX')
bacteria <- merge(bacteria, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
bacteria[, preyper := diet.Bacteria * Rpath.prop]
bacteria <- bacteria[, sum(preyper), by = RPATH]
bacteria[,Rpred := 'Bacteria']
setnames(bacteria, c('RPATH', 'V1'), c('Rprey', 'preyper'))

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,bacteria))

#Macrobenthos - need to merge multiple EMAX groups
Macrobenthos<-Macrobenthos[,macro.prop := Biomass/sum(Biomass)]
poly<-EMAX.params[, list(diet.Macrobenthos..polychaetes,diet.Group)]
setnames(poly, 'diet.Macrobenthos..polychaetes','DC')
poly<-poly[,macro.prop := Macrobenthos[EMAX == 'Macrobenthos- polychaetes',macro.prop]]
crus<-EMAX.params[, list(diet.Macrobenthos..crustaceans,diet.Group)]
setnames(crus, 'diet.Macrobenthos..crustaceans','DC')
crus<-crus[,macro.prop := Macrobenthos[EMAX == 'Macrobenthos- crustaceans',macro.prop]]
moll<-EMAX.params[, list(diet.Macrobenthos..molluscs,diet.Group)]
setnames(moll, 'diet.Macrobenthos..molluscs','DC')
moll<-moll[,macro.prop := Macrobenthos[EMAX == 'Macrobenthos- molluscs',macro.prop]]
oth<-EMAX.params[, list(diet.Macrobenthos..other,diet.Group)]
setnames(oth, 'diet.Macrobenthos..other','DC')
oth<-oth[,macro.prop := Macrobenthos[EMAX == 'Macrobenthos- other',macro.prop]]

#Combine all EMAX groups into one
combo <- rbindlist(list(poly, crus, moll, oth))
combo[, newDC := DC * macro.prop]
combo<-(combo[,sumnewDC := sum(newDC), by = 'diet.Group'])
combo<-unique(combo[,c('diet.Group','sumnewDC')])
setnames(combo, 'diet.Group','EMAX')
combo <- merge(combo, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
combo[, preyper := sumnewDC * Rpath.prop]
#Need to sum many:1 EMAX:Rpath
combo <- combo[, sum(preyper), by = RPATH]
setnames(combo, c('RPATH','V1'),c('Rprey','preyper'))
combo[, Rpred := 'Macrobenthos']

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,combo))

#Megabenthos - need to merge multiple EMAX groups
Megabenthos<-all.groups[RPATH == 'Megabenthos',]
Megabenthos<-Megabenthos[,mega.prop := Biomass/sum(Biomass)]
filter<- EMAX.params[, list(diet.Megabenthos..filterers,diet.Group)]
setnames(filter, 'diet.Megabenthos..filterers','DC')
filter<-filter[,mega.prop := Megabenthos[EMAX == 'Megabenthos- filterers',mega.prop]]
othermega<-EMAX.params[, list(diet.Megabenthos..other,diet.Group)]
setnames(othermega, 'diet.Megabenthos..other','DC')
othermega<-othermega[,mega.prop := Megabenthos[EMAX == 'Megabenthos- other',mega.prop]]

#Combine all EMAX groups into one
combomega <- rbindlist(list(filter, othermega))
combomega[, newDC := DC * mega.prop]
combomega<-(combomega[,sumnewDC := sum(newDC), by = 'diet.Group'])
combomega<-unique(combomega[,c('diet.Group','sumnewDC')])
setnames(combomega, 'diet.Group','EMAX')
combomega <- merge(combomega, all.groups[, list(RPATH, EMAX, Rpath.prop)], by = 'EMAX')
combomega[, preyper := sumnewDC * Rpath.prop]

#Need to sum many:1 EMAX:Rpath
combomega <- combomega[, sum(preyper), by = RPATH]
setnames(combomega, c('RPATH','V1'),c('Rprey','preyper'))
combomega[, Rpred := 'Megabenthos']

GOM.diet.EMAX<-rbindlist(list(GOM.diet.EMAX,combomega))

#Merge diet.survey with diet.EMAX
GOM.diet <- rbindlist(list(GOM.diet.survey, GOM.diet.EMAX), use.names = T)

#Output results to csv
#write.csv(GOM.diet,'GOM_Diet_Matrix.csv')

```
## References
``` {references}
````
